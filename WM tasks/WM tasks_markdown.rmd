---
title: "WM_tasks_Markdown"
author: "Christoph Voelter"
date: "November 21, 2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(lme4)
library(readr)
library(tidyverse)
library(sjPlot)
library(ggthemes)
library(gridExtra)
library(ggpubr)
library(corrr)
#library(Hmisc)
library("PerformanceAnalytics")
source("C:/Users/cjv3/R/R scripts/Roger/diagnostic_fcns.r")
source("C:/Users/cjv3/R/R scripts/Roger/glmm_stability.r")
source("C:/Users/cjv3/R/R scripts/Roger/boxplotteR.r")
source("C:/Users/cjv3/R/R scripts/Roger/boot_glmm.r")
source("C:/Users/cjv3/R/R scripts/Roger/corr_exact.r")
#load(file ="mm1_mult_poss.RData")
#readRDS(file ="multpos_model.rds")
```

```{r loading data, include = FALSE}
#Preparing code for mixed modeling. 
updating.data <- read.table(file="20181121 WM updating data.txt", header=T, sep="\t")
updatingtraining.data <- read.table(file="20181121 WM updating training data.txt", header=T, sep="\t")
boxes.data <- read.table(file="20181121 WM boxes data.txt", header=T, sep="\t")
grid.data <- read.table(file="20181122 WM grid data.txt", header=T, sep="\t")
```
```{r}
summary(updating.data)

```


##Summary



##Plotting data

###Plotting box_changes
```{r error=FALSE}

###Plotting side_changes
grid_individual2 <- grid.data %>%
  filter(!is.na(NrUntilfindGrid)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Type == "test")%>%
  group_by(Subject) %>% 
  summarize(grid_numberAttempts = mean(NrUntilfindGrid)) 

grid_individual <- grid.data %>%
  filter(!is.na(distance_c01)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Type == "test")%>%
  group_by(Subject) %>% 
  summarize(grid_distance = mean(distance_c01)) 

grid_individual3 <- grid.data %>%
  filter(!is.na(choice1_correct)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Type == "test")%>%
  group_by(Subject) %>% 
  summarize(grid_choice1c = mean(choice1_correct)) 

box_individual <- boxes.data %>%
  filter(!is.na(count_mistakes)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Condition == "test")%>%
  group_by(Subject) %>% 
  summarize(boxes_mistakes = mean(count_mistakes)) 

box_individual2 <- boxes.data %>%
  filter(!is.na(Correct_P1)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Condition == "test")%>%
  group_by(Subject) %>% 
  summarize(boxes_P1mistakes = mean(Correct_P1)) 

updating_individual <- updating.data %>%
  filter(!is.na(diff_score)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  group_by(Subject) %>% 
  summarize(updating_diffscore = mean(diff_score))

updating_individual2 <- updating.data %>%
  filter(!is.na(redundant_searches)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  group_by(Subject) %>% 
  summarize(updating_redSearch = mean(redundant_searches))

updating_individual3 <- updating.data %>%
  filter(!is.na(number_retr_food)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  group_by(Subject) %>% 
  summarize(updating_retrfood = mean(number_retr_food))

updatingtraining_individual <- updatingtraining.data %>%
  filter(!is.na(number_redundant_searched)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  group_by(Subject) %>% 
  summarize(updatingTraining_redSearch = mean(number_redundant_searched))

updatingtraining_5boxes <- updatingtraining.data %>%
  filter(!is.na(number_redundant_searched)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Number_boxes==5)%>%
  group_by(Subject) %>% 
  summarize(updatingTraining5_redSearch = mean(number_redundant_searched))


updatingtraining_4boxes <- updatingtraining.data %>%
  filter(!is.na(number_redundant_searched)) %>%
  filter(Subject != "George" & Subject != "Saidia")%>%
  filter(Number_boxes==4)%>%
  group_by(Subject) %>% 
  summarize(updatingTraining4_redSearch = mean(number_redundant_searched))

WM_task_individual <- updating_individual  %>% 
  inner_join(updating_individual2) %>%
  inner_join(updating_individual3)%>%
  inner_join(updatingtraining_individual) %>%
  inner_join(updatingtraining_4boxes)%>%
  inner_join(updatingtraining_5boxes)%>%
  inner_join(box_individual) %>%
  inner_join(box_individual2) %>%
  inner_join(grid_individual) %>%
  inner_join(grid_individual2) %>%
  inner_join(grid_individual3)#%>%

  #filter(Subject != "Edvard")
```

##Test against chance

```{r}
#Updating - training - 5 boxes
mean(updating_individual$updating_diffscore)
mean(updating_individual2$updating_redSearch)

t.test( updatingtraining_5boxes$updatingTraining5_redSearch, mu=3.98, alternative = "two.sided")

t.test( updatingtraining_4boxes$updatingTraining4_redSearch, mu=3.18, alternative = "two.sided")


#Boxes
t.test( box_individual2$boxes_P1mistakes, mu=0.25, alternative = "two.sided")

#Grid
#test against random choices
t.test( grid_individual$grid_distance, mu=1.954, alternative = "two.sided")

#test against inner cell preference - mean
t.test( grid_individual$grid_distance, mu=1.667, alternative = "two.sided")

#test against inner cell preference - median
t.test( grid_individual$grid_distance, mu=1.52, alternative = "two.sided")

hist(grid_individual$grid_distance)
```

```{r}
d <- correlate(WM_task_individual[-1], method="spearman")
d

d %>%
  shave(upper = FALSE) %>%
  rplot() 

#rcorr(as.matrix(WM_task_individual[-1]), type="pearson")

chart.Correlation(WM_task_individual[-1], histogram=TRUE, pch=19, method="pearson")

```

```{r}

WM_task_individual<-WM_task_individual %>%  add_count(updatingTraining_redSearch)

max(WM_task_individual$updatingTraining_redSearch) 

p1 <- 
  ggplot(
  data=WM_task_individual, aes(x=rep(1, 28), y=updatingTraining_redSearch, group=Subject)) +
  geom_point(size = WM_task_individual$n, colour = "purple") +
  geom_line(lty=2)+
  ylim(0,5)+
  labs(x="Updating training",y="Mean redundant choices")+
  theme_few()
 
 
 +
  #scale_y_continuous(breaks=seq(0,1,0.25))+
  g
 
 
 gtitle("Session 1")+
  
   
   
   geom_segment(aes(y = plot_ind_S1_side_mean$mean_correct[1], yend = plot_ind_S1_side_mean$mean_correct[1], x = 1 -0.2, xend = 1 + 0.2))+
  geom_segment(aes(y = plot_ind_S1_side_mean$mean_correct[2], yend = plot_ind_S1_side_mean$mean_correct[2], x = 2 -0.2, xend = 2 + 0.2))+
  stat_compare_means(aes(group = side_change), paired = TRUE, method="t.test", label.x = 1.3)#, label = "p.signif")
 
```



plot_ind_S2_side <- plot_individual_side %>% 
  filter(Session == 2 & side_change!="")%>%
  add_count(correct_resp)

plot_ind_S2_side_mean <- plot_ind_S2_side %>% 
  group_by(side_change) %>% 
  summarize(mean_correct = mean(correct_resp)) 

p2 <- ggplot(
  data=plot_ind_S2_side, aes(side_change, correct_resp, group = Subject)) +   
  geom_point(size = plot_ind_S2_side$n, colour = "purple") +
  geom_line(lty=2)+
  ylim(0,1)+
  labs(x="Side Change",y="Mean correct")+
  theme_few()+
 # scale_y_continuous(breaks=seq(0,1,0.25))+
  ggtitle("Session 2")+
  geom_segment(aes(y = plot_ind_S2_side_mean$mean_correct[1], yend = plot_ind_S2_side_mean$mean_correct[1], x = 1 -0.2, xend = 1 + 0.2))+
  geom_segment(aes(y = plot_ind_S2_side_mean$mean_correct[2], yend = plot_ind_S2_side_mean$mean_correct[2], x = 2 -0.2, xend = 2 + 0.2))+
  stat_compare_means(aes(group = side_change), paired = TRUE, method="t.test", label.x = 1.3)#, label = "p.signif")
 

###plotting box changes
plot_individual_box <- all.data %>%
  filter(Subject != "George")%>%
  group_by(Session, box_change, Subject) %>% 
  summarize(correct_resp = mean(correct)) 

plot_ind_S1_box <- plot_individual_box %>% 
  filter(Session == 1 & box_change!="")%>%
  add_count(correct_resp)

plot_ind_S1_box_mean <- plot_ind_S1_box %>% 
  group_by(box_change) %>% 
  summarize(mean_correct = mean(correct_resp)) 

p3 <- ggplot(
  data=plot_ind_S1_box , aes(box_change, correct_resp, group = Subject)) +   
  geom_point(size = plot_ind_S1_box $n, colour = "purple") +
  geom_line(lty=2)+
  ylim(0,1)+
  labs(x="Box Change",y="Mean correct")+
  theme_few()+
 # scale_y_continuous(breaks=seq(0,1,0.25))+
  geom_segment(aes(y = plot_ind_S1_box_mean $mean_correct[1], yend = plot_ind_S1_box_mean $mean_correct[1], x = 1 -0.2, xend = 1 + 0.2))+
  geom_segment(aes(y = plot_ind_S1_box_mean$mean_correct[2], yend = plot_ind_S1_box_mean $mean_correct[2], x = 2 -0.2, xend = 2 + 0.2))+
  stat_compare_means(aes(group = box_change), paired = TRUE, method="t.test", label.x = 1.3)#, label = "p.signif")
 




plot_ind_S2_box  <- plot_individual_box %>% 
  filter(Session == 2 & box_change!="")%>%
  add_count(correct_resp)

plot_ind_S2_box_mean <- plot_ind_S2_box %>% 
  group_by(box_change) %>% 
  summarize(mean_correct = mean(correct_resp)) 

p4 <- ggplot(
  data=plot_ind_S2_box , aes(box_change, correct_resp, group = Subject)) +   
  geom_point(size = plot_ind_S2_box $n, colour = "purple") +
  geom_line(lty=2)+
  ylim(0,1)+
  labs(x="Box Change",y="Mean correct")+
  theme_few()+
 # scale_y_continuous(breaks=seq(0,1,0.25))+
  geom_segment(aes(y = plot_ind_S2_box_mean $mean_correct[1], yend = plot_ind_S2_box_mean $mean_correct[1], x = 1 -0.2, xend = 1 + 0.2))+
  geom_segment(aes(y = plot_ind_S2_box_mean$mean_correct[2], yend = plot_ind_S2_box_mean $mean_correct[2], x = 2 -0.2, xend = 2 + 0.2))+
  stat_compare_means(aes(group = box_change), paired = TRUE, method="t.test", label.x = 1.3)#, label = "p.signif")
 

grid.arrange(p1, p2,p3,p4, nrow = 2)
 g <- arrangeGrob(p1, p2,p3,p4, nrow = 2)
ggsave("tray_shifting_trial effects.jpeg",g, width = 10, height = 7)



```



\pagebreak  

##Paired-sample t-test
```{r}


t.test( plot_ind_S1_side[plot_ind_S1_side$side_change=="no",]$correct_resp, plot_ind_S1_side[plot_ind_S1_side$side_change=="yes",]$correct_resp, paired = TRUE, alternative = "two.sided")


t.test( plot_ind_S2_side[plot_ind_S2_side$side_change=="no",]$correct_resp, plot_ind_S2_side[plot_ind_S2_side$side_change=="yes",]$correct_resp, paired = TRUE, alternative = "two.sided")



t.test( plot_ind_S1_box[plot_ind_S1_box$box_change=="no",]$correct_resp, plot_ind_S1_box[plot_ind_S1_box$box_change=="yes",]$correct_resp, paired = TRUE, alternative = "two.sided")


t.test( plot_ind_S2_box[plot_ind_S2_box$box_change=="no",]$correct_resp, plot_ind_S2_box[plot_ind_S2_box$box_change=="yes",]$correct_resp, paired = TRUE, alternative = "two.sided")

# compare_means(correct_resp ~ side_change, data = plot_ind_S1_side, paired = TRUE, method="t.test")


plot_individual <- all.data %>%
  group_by(Session, Subject) %>% 
  summarize(correct_resp = mean(correct)) 

mean(plot_individual[plot_individual$Session==1,]$correct_resp, na.rm=TRUE)
mean(plot_individual[plot_individual$Session==2,]$correct_resp, na.rm=TRUE)

t.test( plot_individual[plot_individual$Session==1,]$correct_resp, mu=0.5, alternative = "two.sided")
t.test( plot_individual[plot_individual$Session==2,]$correct_resp, mu=0.5, alternative = "two.sided")




```


###Plotting box_distribution
```{r error=FALSE}



plot_individual_distractor1 <- all.data %>%
  filter(Subject != "George" & Subject != "Saidia" & Subject != "Safari" )%>%
  filter(Session == 1)%>%
  group_by(chosen_distractor, Subject) %>% 
  count(chosen_distractor) %>%
  mutate(n = n/24)
  

ggplot(plot_individual_distractor1, aes(x=n, fill=chosen_distractor)) +
    geom_histogram(binwidth=0.05, alpha=.5, position="identity")

plot_individual_distractor2 <- all.data %>%
  filter(Subject != "George" & Subject != "Saidia" & Subject != "Safari" )%>%
  filter(Session == 2)%>%
  group_by(chosen_distractor, Subject) %>% 
  count(chosen_distractor) %>%
  mutate(n = n/24)

ggplot(plot_individual_distractor2, aes(x=n, fill=chosen_distractor)) +
    geom_histogram(binwidth=0.05, alpha=.5, position="identity")

```


## GLMM

``` {r mixed modeling, error=TRUE}

# centering variables for modeling
model.data <- all.data %>% 
  mutate(z.trial = scale(trial, scale = T, center = T),
         condition = relevel(condition, ref = "control"))

## code to run the model
mm.1 <- glmer(both_ropes ~ condition + z.trial + 
               (1 + condition + z.trial |chimp)
             , data = model.data
             , family = binomial
             #, control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))
)

## save model output
#saveRDS(mm.1, "multpos_model.rds")
#save.image("mm1_mult_poss.RData")
```
####Confidence intervals
Confidence intervals for the binomial models were derived using the function bootMer of the R package lme4, using 1,000 parametric bootstraps and bootstrapping over the random effects.

```{R}		
#boot.res=boot.glmm(model.res=mm.1, excl.warnings=T,nboots=1000, para=F)
#saveRDS(mm.1, "multpos_model.rds")
round(boot.res,3)
```

####Null model	 
```{r}	 
mm.1.null <- glmer(both_ropes ~ 1 + 
               (1 + condition + z.trial |chimp)
             , data = model.data
             , family = binomial
            # , control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5))
)

```
####Full-null model comparison
```{r}	 
anova(mm.1, mm.1.null, test="Chisq")
```
####Model output
  + Coefficients
```{r}
round(summary(mm.1)$coefficients, 3)
```
  + Individual predictors: likelihood ratio tests  
Drop1: P values for the individual effects were based on likelihood ratio tests comparing the full with respective reduced models (Barr et al., 2013; R function drop1 with argument 'test' set to "Chisq"). 
```{r}
xdrop1=drop1(mm.1, test="Chisq")
round(xdrop1,3)
```


#### check for colinearity in the previous model.

```{R echo=FALSE}
library (car)

col.mm1 <- glm(both_ropes ~ condition + z.trial 
             , data = model.data
             , family = binomial
)
vif(col.mm1)
#no problem
```
-> no collinearity

####Model output
`````` {r plot mixed modeling, error=TRUE}

plot_model(mm.1, type='est') 
plot_model(mm.1, type='re') 
```





